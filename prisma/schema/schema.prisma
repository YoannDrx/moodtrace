// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Feedback {
  id      String  @id @default(nanoid(11))
  review  Int
  message String
  email   String?
  userId  String?
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// MoodTrace Domain Models
// ============================================

/// MoodEntry - Entrée quotidienne d'humeur
model MoodEntry {
  id             String   @id @default(nanoid(11))
  userId         String
  organizationId String
  date           DateTime @db.Date
  mood           Int      // 1-10
  energy         Int?     // 1-10
  sleepHours     Float?
  sleepQuality   Int?     // 1-10
  anxiety        Int?     // 1-10
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, date])
  @@index([userId, date])
  @@index([organizationId, date])
  @@map("mood_entry")
}

/// Medication - Médicament du patient
model Medication {
  id             String    @id @default(nanoid(11))
  userId         String
  organizationId String
  name           String    // "Lamictal"
  molecule       String?   // "Lamotrigine"
  dosageMg       Int
  frequency      String    // "daily", "twice_daily", "three_times_daily", "as_needed"
  timeOfDay      String?   // "morning", "evening", "both", "night"
  color          String?   // Pour l'UI
  startDate      DateTime  @db.Date
  endDate        DateTime? @db.Date
  isActive       Boolean   @default(true)
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  intakes      MedicationIntake[]
  changes      MedicationChange[]

  @@index([userId, isActive])
  @@index([organizationId])
  @@map("medication")
}

/// MedicationIntake - Prise quotidienne de médicament
model MedicationIntake {
  id           String   @id @default(nanoid(11))
  userId       String
  medicationId String
  date         DateTime @db.Date
  scheduledAt  String?  // "08:00", "20:00"
  takenAt      String?  // "08:15" ou null si non pris
  status       String   // "taken", "missed", "skipped", "delayed"
  notes        String?

  createdAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@unique([medicationId, date, scheduledAt])
  @@index([userId, date])
  @@index([medicationId, date])
  @@map("medication_intake")
}

/// MedicationChange - Historique des changements de dosage
model MedicationChange {
  id               String   @id @default(nanoid(11))
  medicationId     String
  previousDosageMg Int
  newDosageMg      Int
  changeDate       DateTime @db.Date
  reason           String?  // "augmentation palier", "effet secondaire", "stabilisation"
  prescribedBy     String?  // Nom du médecin

  createdAt DateTime @default(now())

  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@index([medicationId, changeDate])
  @@map("medication_change")
}

/// CaregiverObservation - DEPRECATED: Migrer vers CaregiverDailyCheckin + CaregiverEvent
/// @deprecated Utiliser CaregiverDailyCheckin et CaregiverEvent à la place
model CaregiverObservation {
  id              String   @id @default(nanoid(11))
  caregiverId     String   // User ID de l'aidant (membre avec role "caregiver")
  patientId       String   // User ID du patient
  organizationId  String
  date            DateTime @db.Date
  moodObservation String   // "very_good", "good", "neutral", "down", "very_down", "concerning"
  energyLevel     String?  // "high", "normal", "low", "very_low"
  socialBehavior  String?  // "engaged", "normal", "withdrawn", "isolated"
  sleepObserved   String?  // "good", "restless", "insomnia", "oversleeping"
  notes           String?
  isPrivate       Boolean  @default(false) // Si true, non visible par le patient

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caregiver    User         @relation("CaregiverObservations", fields: [caregiverId], references: [id], onDelete: Cascade)
  patient      User         @relation("PatientObservations", fields: [patientId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([caregiverId, patientId, organizationId, date])
  @@index([patientId, date])
  @@index([organizationId, date])
  @@map("caregiver_observation")
}

// ============================================
// Nouveau système d'observations aidant (v2)
// ============================================

/// CaregiverDailyCheckin - Check-in quotidien de l'aidant (1 par jour max par aidant/patient)
model CaregiverDailyCheckin {
  id        String   @id @default(nanoid(11))
  authorId  String   // L'aidant qui observe
  subjectId String   // Le patient observé
  spaceId   String   // organizationId (espace santé)
  date      DateTime @db.Date

  // Observations
  moodObserved   String? // "very_good" | "good" | "neutral" | "down" | "very_down" | "concerning"
  energyObserved String? // "high" | "normal" | "low" | "very_low"
  socialBehavior String? // "engaged" | "normal" | "withdrawn" | "isolated"
  sleepObserved  String? // "good" | "restless" | "insomnia" | "oversleeping"
  notes          String?

  patientVisibility String @default("visible") // "visible" | "hidden" (caché au patient)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author       User         @relation("AuthorCheckins", fields: [authorId], references: [id], onDelete: Cascade)
  subject      User         @relation("SubjectCheckins", fields: [subjectId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([authorId, subjectId, spaceId, date])
  @@index([subjectId, date])
  @@index([authorId, date])
  @@map("caregiver_daily_checkin")
}

/// CaregiverEvent - Événements ponctuels signalés par l'aidant (multiples par jour possible)
model CaregiverEvent {
  id        String @id @default(nanoid(11))
  authorId  String // L'aidant qui signale
  subjectId String // Le patient concerné
  spaceId   String // organizationId (espace santé)

  occurredAt DateTime // Date/heure de l'événement
  eventType  String   // "compulsive_purchase" | "crisis" | "conflict" | "milestone" | "medication_issue" | "other"
  severity   Int      // 1-5 (1=mineur, 5=grave)
  title      String   // Titre court (max 100 chars)
  details    String?  // Détails (max 1000 chars)

  patientVisibility String @default("visible") // "visible" | "hidden" (caché au patient)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author       User         @relation("AuthorEvents", fields: [authorId], references: [id], onDelete: Cascade)
  subject      User         @relation("SubjectEvents", fields: [subjectId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([subjectId, occurredAt])
  @@index([authorId, occurredAt])
  @@index([spaceId, eventType])
  @@map("caregiver_event")
}
